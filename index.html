<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IBAN-Erfassung – SIKURA Leben AG i.L.</title>
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <main class="container">
    <section>
      <h1>Bitte bestätigen Sie Ihre bereits erfassten Daten</h1>
      <p class="hint">Diese Angaben stammen aus Ihrem bestehenden Prozess und sind nur zur Kontrolle sichtbar.</p>
      <div class="grid">
        <label>Gläubiger‑Nr.<input id="ro_creditor" disabled /></label>
        <label>Vorname<input id="ro_firstname" disabled /></label>
        <label>Nachname<input id="ro_lastname" disabled /></label>
        <label>Strasse<input id="ro_street" disabled /></label>
        <label>Nr.<input id="ro_houseno" disabled /></label>
        <label>PLZ<input id="ro_zip" disabled /></label>
        <label>Ort<input id="ro_city" disabled /></label>
        <label>Land<input id="ro_country" disabled /></label>
      </div>
    </section>
    <hr/>
    <section>
      <h2>IBAN erfassen</h2>
      <form id="ibanForm" method="POST" action="/.netlify/functions/iban_submit" novalidate>
        <label>IBAN*<input id="iban" name="iban" required maxlength="34" placeholder="CH93 0076 2011 6238 5295 7" /></label>
        <input type="hidden" id="hid_id" name="id" />
        <input type="hidden" id="hid_token" name="token" />
        <input type="hidden" id="hid_em" name="em" />
        <input type="hidden" id="hid_lang" name="lang" />
        <div class="checks">
          <label><input type="checkbox" id="cb1" required /> Ich bestätige, dass die Angaben korrekt sind.</label>
          <label><input type="checkbox" id="cb2" required /> Ich stimme der Verarbeitung gemäss Datenschutzhinweisen zu.</label>
        </div>
        <button type="submit">Senden</button>
        <p class="small"><a href="/privacy.html" target="_blank" rel="noopener">Datenschutzhinweise</a></p>
      </form>
    </section>
  </main>
  <script>
    function ibanSanitize(s){ return String(s||'').toUpperCase().replace(/\s+/g,''); }
    function toNum(ch){ const c=ch.charCodeAt(0); if(c>=48&&c<=57) return ch; if(c>=65&&c<=90) return String(c-55); return ''; }
    function mod97Str(str){ let rem=0,buf=''; for(const ch of str){ buf+=toNum(ch); while(buf.length>=7){ rem = Number(String(rem)+buf.slice(0,7))%97; buf = buf.slice(7);} } if(buf.length) rem = Number(String(rem)+buf)%97; return rem; }
    function ibanIsValid(raw){ const s=ibanSanitize(raw); if(!/^[A-Z]{2}\d{2}[A-Z0-9]{11,30}$/.test(s)) return false; const rearr=s.slice(4)+s.slice(0,4); return mod97Str(rearr)===1; }
    function ibanGroup(v){ const s=ibanSanitize(v); return s.replace(/(.{4})/g,'$1 ').trim(); }

    const qs = new URLSearchParams(location.search);
    const q_id    = (qs.get('id')||'').trim();
    const q_token = (qs.get('token')||'').trim();
    const q_em    = (qs.get('em')||'').trim();
    const q_lang  = (qs.get('lang')||'de').toLowerCase();

    document.getElementById('hid_id').value    = q_id;
    document.getElementById('hid_token').value = q_token;
    document.getElementById('hid_em').value    = q_em;
    document.getElementById('hid_lang').value  = q_lang;
    document.getElementById('ro_creditor').value = q_id;

    (async () => {
      try {
        const url = `/.netlify/functions/iban_check?id=${encodeURIComponent(q_id)}&token=${encodeURIComponent(q_token)}&lang=${encodeURIComponent(q_lang)}&em=${encodeURIComponent(q_em)}`;
        const r = await fetch(url);
        if(!r.ok) throw new Error('iban_check_failed');
        const j = await r.json();
        const p = j.display || {};
        document.getElementById('ro_firstname').value = p.firstname || '';
        document.getElementById('ro_lastname').value  = p.name || '';
        document.getElementById('ro_street').value    = p.strasse || '';
        document.getElementById('ro_houseno').value   = p.hausnummer || '';
        document.getElementById('ro_zip').value       = p.plz || '';
        document.getElementById('ro_city').value      = p.ort || '';
        document.getElementById('ro_country').value   = p.land || '';
      } catch(e){
        alert('Der Zugriffslink ist ungültig oder abgelaufen.');
      }
    })();

    const $iban = document.getElementById('iban');
    document.getElementById('ibanForm').addEventListener('submit', (ev) => {
      const rawIban = $iban.value;
      if(!ibanIsValid(rawIban)){ ev.preventDefault(); alert('Bitte eine gültige IBAN eingeben (Format & Prüfsumme).'); return; }
      $iban.value = ibanSanitize(rawIban); // ohne Leerzeichen senden
    });
    $iban.addEventListener('input', () => { $iban.value = ibanGroup($iban.value); });
  </script>
</body>
</html>
