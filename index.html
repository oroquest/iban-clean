<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IBAN – SIKURA Leben AG i.L.</title>
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <main class="container">
    <!-- READ-ONLY VERIFY DATA -->
    <section>
      <h1 data-i18n="title_check">Bitte bestätigen Sie Ihre bereits erfassten Daten</h1>
      <p class="hint" data-i18n="subtitle_check">Diese Angaben stammen aus Ihrem bestehenden Prozess und sind nur zur Kontrolle sichtbar.</p>
      <div class="grid">
        <label><span data-i18n="field_creditor">Gläubiger‑Nr.</span>
          <input id="ro_creditor" disabled /></label>
        <label><span data-i18n="field_firstname">Vorname</span>
          <input id="ro_firstname" disabled /></label>
        <label><span data-i18n="field_lastname">Nachname</span>
          <input id="ro_lastname" disabled /></label>
        <label><span data-i18n="field_street">Strasse</span>
          <input id="ro_street" disabled /></label>
        <label><span data-i18n="field_houseno">Nr.</span>
          <input id="ro_houseno" disabled /></label>
        <label><span data-i18n="field_zip">PLZ</span>
          <input id="ro_zip" disabled /></label>
        <label><span data-i18n="field_city">Ort</span>
          <input id="ro_city" disabled /></label>
        <label><span data-i18n="field_country">Land</span>
          <input id="ro_country" disabled /></label>
      </div>
    </section>

    <hr/>

    <!-- IBAN FORM -->
    <section>
      <h2 data-i18n="title_iban">IBAN erfassen</h2>
      <form id="ibanForm" method="POST" action="/.netlify/functions/iban_submit" novalidate>
        <label><span data-i18n="field_iban">IBAN*</span>
          <input id="iban" name="iban" required maxlength="34" placeholder="CH93 0076 2011 6238 5295 7" /></label>

        <!-- Hidden: verify params -->
        <input type="hidden" id="hid_id" name="id" />
        <input type="hidden" id="hid_token" name="token" />
        <input type="hidden" id="hid_em" name="em" />
        <input type="hidden" id="hid_lang" name="lang" />

        <div class="checks">
          <label><input type="checkbox" id="cb1" required />
            <span data-i18n="check_correct">Ich bestätige, dass die Angaben korrekt sind.</span></label>
          <label><input type="checkbox" id="cb2" required />
            <span data-i18n="check_privacy">Ich stimme der Verarbeitung gemäss Datenschutzhinweisen zu.</span></label>
        </div>

        <button type="submit" data-i18n="btn_send">Senden</button>
        <p class="small"><a href="/privacy.html" target="_blank" rel="noopener" data-i18n="link_privacy">Datenschutzhinweise</a></p>
      </form>
    </section>
  </main>

  <script>
    // -------- i18n dictionary (IT falls back to EN) --------
    const I18N = {
      de: {
        title_check: "Bitte bestätigen Sie Ihre bereits erfassten Daten",
        subtitle_check: "Diese Angaben stammen aus Ihrem bestehenden Prozess und sind nur zur Kontrolle sichtbar.",
        field_creditor: "Gläubiger‑Nr.",
        field_firstname: "Vorname",
        field_lastname: "Nachname",
        field_street: "Strasse",
        field_houseno: "Nr.",
        field_zip: "PLZ",
        field_city: "Ort",
        field_country: "Land",
        title_iban: "IBAN erfassen",
        field_iban: "IBAN*",
        check_correct: "Ich bestätige, dass die Angaben korrekt sind.",
        check_privacy: "Ich stimme der Verarbeitung gemäss Datenschutzhinweisen zu.",
        btn_send: "Senden",
        link_privacy: "Datenschutzhinweise",
        err_invalid_link: "Der Zugriffslink ist ungültig oder abgelaufen.",
        err_iban_invalid: "Bitte eine gültige IBAN eingeben (Format & Prüfsumme)."
      },
      en: {
        title_check: "Please confirm your already provided data",
        subtitle_check: "The following information is from your existing process and is shown for review only.",
        field_creditor: "Creditor no.",
        field_firstname: "First name",
        field_lastname: "Last name",
        field_street: "Street",
        field_houseno: "No.",
        field_zip: "ZIP",
        field_city: "City",
        field_country: "Country",
        title_iban: "Enter IBAN",
        field_iban: "IBAN*",
        check_correct: "I confirm that the information is correct.",
        check_privacy: "I agree to the processing according to the privacy notice.",
        btn_send: "Submit",
        link_privacy: "Privacy notice",
        err_invalid_link: "The access link is invalid or has expired.",
        err_iban_invalid: "Please enter a valid IBAN (format & checksum)."
      }
    };
    function normLang(l){ l=(l||"de").toLowerCase(); return l==="it"?"en":(I18N[l]?l:"de"); }
    function applyI18n(lang){
      const dict = I18N[lang] || I18N.de;
      document.documentElement.lang = lang;
      document.querySelectorAll("[data-i18n]").forEach(el => {
        const key = el.getAttribute("data-i18n");
        if (dict[key]) el.textContent = dict[key];
      });
    }

    // -------- IBAN helpers --------
    function ibanSanitize(s){ return String(s||'').toUpperCase().replace(/\s+/g,''); }
    function toNum(ch){ const c=ch.charCodeAt(0); if(c>=48&&c<=57) return ch; if(c>=65&&c<=90) return String(c-55); return ''; }
    function mod97Str(str){ let rem=0,buf=''; for(const ch of str){ buf+=toNum(ch); while(buf.length>=7){ rem = Number(String(rem)+buf.slice(0,7))%97; buf = buf.slice(7);} } if(buf.length) rem = Number(String(rem)+buf)%97; return rem; }
    function ibanIsValid(raw){ const s=ibanSanitize(raw); if(!/^[A-Z]{2}\d{2}[A-Z0-9]{11,30}$/.test(s)) return false; const rearr=s.slice(4)+s.slice(0,4); return mod97Str(rearr)===1; }
    function ibanGroup(v){ const s=ibanSanitize(v); return s.replace(/(.{4})/g,'$1 ').trim(); }

    // -------- URL params & lang --------
    const qs = new URLSearchParams(location.search);
    const q_id    = (qs.get('id')||'').trim();
    const q_token = (qs.get('token')||'').trim();
    const q_em    = (qs.get('em')||'').trim();
    const q_lang0 = (qs.get('lang')||'de').toLowerCase();
    const q_lang  = normLang(q_lang0);
    applyI18n(q_lang);

    // Hidden fields
    document.getElementById('hid_id').value    = q_id;
    document.getElementById('hid_token').value = q_token;
    document.getElementById('hid_em').value    = q_em;
    document.getElementById('hid_lang').value  = q_lang;
    document.getElementById('ro_creditor').value = q_id;

    // -------- Load read-only verify data via IBAN check --------
    (async () => {
      try {
        const url = `/.netlify/functions/iban_check?id=${encodeURIComponent(q_id)}&token=${encodeURIComponent(q_token)}&lang=${encodeURIComponent(q_lang)}&em=${encodeURIComponent(q_em)}`;
        const r = await fetch(url);
        if(!r.ok) throw new Error('iban_check_failed');
        const j = await r.json();
        const p = j.display || {};
        document.getElementById('ro_firstname').value = p.firstname || '';
        document.getElementById('ro_lastname').value  = p.name || '';
        document.getElementById('ro_street').value    = p.strasse || '';
        document.getElementById('ro_houseno').value   = p.hausnummer || '';
        document.getElementById('ro_zip').value       = p.plz || '';
        document.getElementById('ro_city').value      = p.ort || '';
        document.getElementById('ro_country').value   = p.land || '';
      } catch(e){
        alert(I18N[q_lang]?.err_invalid_link || I18N.de.err_invalid_link);
      }
    })();

    // -------- Form behaviour --------
    const $iban = document.getElementById('iban');
    $iban.addEventListener('input', () => { $iban.value = ibanGroup($iban.value); });
    document.getElementById('ibanForm').addEventListener('submit', (ev) => {
      if (!ibanIsValid($iban.value)) {
        ev.preventDefault();
        alert(I18N[q_lang]?.err_iban_invalid || I18N.de.err_iban_invalid);
        return;
      }
      $iban.value = ibanSanitize($iban.value);
    });
  </script>
</body>
</html>
